{% extends "base.html" %}

{% block title %}æ·±åº¦åˆ†æ - FinSectorForecast{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-search-dollar me-2 text-warning"></i>
            æ·±åº¦åˆ†æ
        </h2>
    </div>
</div>

<!-- åˆ†æé€‰æ‹© -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card has-dropdown">
            <div class="card-header">
                <i class="fas fa-crosshairs me-2"></i>é€‰æ‹©åˆ†ææ¿å—
            </div>
            <div class="card-body" style="position: relative; overflow: visible;">
                <div class="row g-3 align-items-end">
                    <div class="col-md-8">
                        <label class="form-label">æ¿å—é€‰æ‹©</label>
                        <div class="dropdown" id="analysisSectorDropdownContainer">
                            <button class="btn btn-outline-primary w-100 text-start d-flex justify-content-between align-items-center" 
                                    type="button" id="analysisSectorDropdownBtn" onclick="toggleAnalysisSectorDropdown()">
                                <span id="analysisSelectedSectorText">è¯·é€‰æ‹©æ¿å—</span>
                                <i class="fas fa-chevron-down" id="analysisSectorDropdownIcon"></i>
                            </button>
                            <div class="dropdown-menu w-100 p-3" id="analysisSectorDropdownMenu" style="display: none; position: absolute; z-index: 99999; max-height: 400px; overflow-y: auto; top: 100%; left: 0;">
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm" id="analysisSectorSearchInput" placeholder="æœç´¢æ¿å—..." oninput="filterAnalysisSectors(this.value)" style="color: black !important;">
                                </div>
                                <hr class="my-2">
                                <div id="analysisSectorList">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2 text-muted">æ­£åœ¨åŠ è½½æ¿å—åˆ—è¡¨...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="analysisSector" value="">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-warning w-100" style="color: #333;" onclick="startAnalysis()">
                            <i class="fas fa-rocket me-1"></i>å¼€å§‹åˆ†æ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>åˆ†æè¯´æ˜
            </div>
            <div class="card-body">
                <ul class="text-muted small mb-0">
                    <li><i class="fas fa-check me-1 text-success"></i>å®Œæ•´æ¨¡å‹è®­ç»ƒ</li>
                    <li><i class="fas fa-check me-1 text-success"></i>ç»¼åˆé¢„æµ‹åˆ†æ</li>
                    <li><i class="fas fa-check me-1 text-success"></i>30+æŠ€æœ¯æŒ‡æ ‡å±•ç¤º</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- åŠ è½½çŠ¶æ€ -->
<div class="row" id="loadingSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <div class="loading-spinner" style="width: 50px; height: 50px; margin: 0 auto;"></div>
                <h5 class="mt-3" id="loadingText">æ­£åœ¨åˆ†æ...</h5>
                <p class="text-muted">è¯·è€å¿ƒç­‰å¾…ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´</p>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†æç»“æœ -->
<div class="row" id="resultSection" style="display: none;">
    <!-- é¢„æµ‹æ—¥æœŸæ˜¾ç¤º -->
    <div class="col-12 mb-3">
        <div class="prediction-date">
            <span class="date-label">ğŸ“Š é¢„æµ‹ç›®æ ‡æ—¥æœŸï¼š</span>
            <span class="date-value" id="analysisTargetDate">--</span>
            <span class="ms-3 date-label">ï¼ˆåŸºäº <span id="analysisBaseDate">--</span> æ•°æ®ï¼‰</span>
        </div>
    </div>
    
    <!-- æ¬¡æ—¥é¢„æµ‹ç»“æœ -->
    <div class="col-md-6 mx-auto">
        <div class="card h-100">
            <div class="card-header bg-primary bg-opacity-25" style="padding: 0.5rem 1rem;">
                <i class="fas fa-bullseye me-2"></i>æ¬¡æ—¥é¢„æµ‹ç»“æœ
            </div>
            <div class="card-body text-center" style="padding: 0.75rem;">
                <div class="mb-2">
                    <div class="h4 fw-bold text-primary mb-1" id="probValue">--</div>
                    <small class="text-muted">å‡†ç¡®ç‡</small>
                </div>
                <div class="probability-bar mb-2" style="height: 8px;">
                    <div class="probability-fill" id="probBar" style="width: 0%"></div>
                </div>
                <div class="d-flex justify-content-around">
                    <div>
                        <div class="h6 mb-0" id="returnValue">--</div>
                        <small class="text-muted">é¢„æµ‹æ¶¨å¹…</small>
                    </div>
                    <div>
                        <div class="h6 mb-0" id="signalValue">--</div>
                        <small class="text-muted">äº¤æ˜“ä¿¡å·</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¬¬äºŒè¡Œï¼šäº¤æ˜“ä¿¡å·åˆ†æï¼ˆå æ®æ•´è¡Œï¼‰ -->
    <div class="col-12 mt-3">
        <div class="card">
            <div class="card-header bg-info bg-opacity-25">
                <i class="fas fa-comment-alt me-2"></i>äº¤æ˜“ä¿¡å·åˆ†æ
            </div>
            <div class="card-body">
                <div id="signalAnalysisContent">
                    <p class="text-muted text-center">åˆ†æå†…å®¹åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å½“å‰å¸‚åœº -->
<div class="row mt-4" id="marketSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning bg-opacity-25" style="color: #333;">
                <i class="fas fa-chart-line me-2"></i>å½“å‰å¸‚åœº
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-md-3 col-6">
                        <div class="market-metric-card">
                            <div class="market-metric-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="market-metric-content">
                                <div class="market-metric-value" id="closePrice">--</div>
                                <div class="market-metric-label">æ”¶ç›˜ä»·</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="market-metric-card">
                            <div class="market-metric-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="market-metric-content">
                                <div class="market-metric-value" id="dailyChange">--</div>
                                <div class="market-metric-label">å½“æ—¥æ¶¨è·Œ</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="market-metric-card">
                            <div class="market-metric-icon">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="market-metric-content">
                                <div class="market-metric-value" id="netInflow">--</div>
                                <div class="market-metric-label">èµ„é‡‘æµå‘</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="market-metric-card">
                            <div class="market-metric-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="market-metric-content">
                                <div class="market-metric-value" id="volumeChange">--</div>
                                <div class="market-metric-label">æˆäº¤é‡å˜åŒ–</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* å½“å‰å¸‚åœºæ¿å—æ ·å¼ */
.market-metric-card {
    background: linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.03) 100%);
    border-radius: 12px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
    border: 1px solid rgba(255,255,255,0.05);
}

.market-metric-card:hover {
    background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.06) 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.market-metric-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
}

.market-metric-card:nth-child(1) .market-metric-icon {
    background: linear-gradient(135deg, rgba(77, 163, 255, 0.2), rgba(77, 163, 255, 0.1));
    color: #4da3ff;
}

.market-metric-card:nth-child(2) .market-metric-icon {
    background: linear-gradient(135deg, rgba(255, 77, 79, 0.2), rgba(255, 77, 79, 0.1));
    color: #ff4d4f;
}

.market-metric-card:nth-child(3) .market-metric-icon {
    background: linear-gradient(135deg, rgba(93, 216, 121, 0.2), rgba(93, 216, 121, 0.1));
    color: #5dd879;
}

.market-metric-card:nth-child(4) .market-metric-icon {
    background: linear-gradient(135deg, rgba(255, 212, 59, 0.2), rgba(255, 212, 59, 0.1));
    color: #ffd43b;
}

.market-metric-content {
    flex: 1;
    min-width: 0;
}

.market-metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1.3;
    margin-bottom: 0.25rem;
    word-break: break-all;
}

.market-metric-label {
    color: var(--text-muted);
    font-size: 0.85rem;
    font-weight: 500;
}

/* æ¶¨è·Œé¢œè‰² */
.market-metric-value.text-up {
    color: var(--up-color);
}

.market-metric-value.text-down {
    color: var(--down-color);
}

.market-metric-value.text-neutral {
    color: var(--gray-color);
}
</style>

<!-- è¯¦ç»†æŒ‡æ ‡ -->
<div class="row mt-4" id="detailSection" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-list-alt me-2"></i>å®Œæ•´æŠ€æœ¯æŒ‡æ ‡
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- ä»·æ ¼ç‰¹å¾ -->
                    <div class="col-md-6 mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-chart-line me-2"></i>ä»·æ ¼ç‰¹å¾
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-dark" id="priceFeatures">
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- èµ„é‡‘ç‰¹å¾ -->
                    <div class="col-md-6 mb-4">
                        <h6 class="text-success mb-3">
                            <i class="fas fa-coins me-2"></i>èµ„é‡‘ç‰¹å¾
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-dark" id="fundFeatures">
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- åŠ¨é‡ç‰¹å¾ -->
                    <div class="col-md-6 mb-4">
                        <h6 class="text-warning mb-3" style="color: #ffc107 !important;">
                            <i class="fas fa-bolt me-2"></i>åŠ¨é‡ç‰¹å¾
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-dark" id="momentumFeatures">
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- æˆäº¤é‡ç‰¹å¾ -->
                    <div class="col-md-6 mb-4">
                        <h6 class="text-info mb-3">
                            <i class="fas fa-chart-bar me-2"></i>æˆäº¤é‡ç‰¹å¾
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-dark" id="volumeFeatures">
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è®­ç»ƒç»“æœ -->
<div class="row mt-4" id="trainResultSection" style="display: none;">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-clipboard-check me-2"></i>æ¨¡å‹è®­ç»ƒç»“æœ
            </div>
            <div class="card-body">
                <pre class="bg-dark text-light p-3 rounded" id="trainResultContent"></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// æœ¬åœ°ç¼“å­˜é”®å
const CACHE_KEY_ANALYSIS = 'analysis_page_cache';

// ä»»åŠ¡çŠ¶æ€ç¼“å­˜é”®å
const TASK_KEY_ANALYSIS = 'analysis_task_status';

// æ¿å—åˆ—è¡¨æœ¬åœ°ç¼“å­˜é”®å
const SECTORS_LOCAL_CACHE_KEY = 'sectors_local_cache';
const SECTORS_CACHE_TTL = 3600000; // 1å°æ—¶ï¼ˆæ¯«ç§’ï¼‰

// è·å–æœ¬åœ°ç¼“å­˜çš„æ¿å—åˆ—è¡¨
function getLocalSectorsCache() {
    try {
        const cached = localStorage.getItem(SECTORS_LOCAL_CACHE_KEY);
        if (cached) {
            const data = JSON.parse(cached);
            const now = Date.now();
            if (data.timestamp && (now - data.timestamp) < SECTORS_CACHE_TTL) {
                return data.sectors;
            }
        }
    } catch (e) {
        console.error('è¯»å–æœ¬åœ°æ¿å—ç¼“å­˜å¤±è´¥:', e);
    }
    return null;
}

// ä¿å­˜æ¿å—åˆ—è¡¨åˆ°æœ¬åœ°ç¼“å­˜
function saveLocalSectorsCache(sectors) {
    try {
        const data = {
            sectors: sectors,
            timestamp: Date.now()
        };
        localStorage.setItem(SECTORS_LOCAL_CACHE_KEY, JSON.stringify(data));
    } catch (e) {
        console.error('ä¿å­˜æœ¬åœ°æ¿å—ç¼“å­˜å¤±è´¥:', e);
    }
}

// å¼‚æ­¥åŠ è½½æ¿å—åˆ—è¡¨
async function loadAnalysisSectors() {
    const sectorListEl = document.getElementById('analysisSectorList');
    if (!sectorListEl) return;
    
    // å…ˆå°è¯•ä»æœ¬åœ°ç¼“å­˜è¯»å–
    const localSectors = getLocalSectorsCache();
    if (localSectors && localSectors.length > 0) {
        console.log('ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„æ¿å—åˆ—è¡¨');
        renderAnalysisSectors(localSectors);
        return;
    }
    
    // æœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨æˆ–è¿‡æœŸï¼Œä»æœåŠ¡å™¨è·å–
    try {
        const response = await fetch('/api/sectors');
        const result = await response.json();
        
        if (result.success && result.data) {
            saveLocalSectorsCache(result.data);
            renderAnalysisSectors(result.data);
        } else {
            sectorListEl.innerHTML = '<div class="text-danger px-3">åŠ è½½å¤±è´¥</div>';
        }
    } catch (e) {
        console.error('åŠ è½½æ¿å—åˆ—è¡¨å¤±è´¥:', e);
        sectorListEl.innerHTML = '<div class="text-danger px-3">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
    }
}

// æ¸²æŸ“æ¿å—åˆ—è¡¨
function renderAnalysisSectors(sectors) {
    const sectorListEl = document.getElementById('analysisSectorList');
    if (!sectorListEl) return;
    
    sectorListEl.innerHTML = sectors.map(sector => 
        `<div class="analysis-sector-item" data-sector="${sector}" onclick="selectAnalysisSector('${sector}')" style="cursor: pointer; padding: 8px 12px; border-radius: 4px; margin-bottom: 2px; background: transparent;">
            ${sector}
        </div>`
    ).join('');
}

// é¡µé¢åŠ è½½å®Œæˆåå¼‚æ­¥åŠ è½½æ¿å—åˆ—è¡¨
document.addEventListener('DOMContentLoaded', function() {
    loadAnalysisSectors();
});

// ä¿å­˜ä»»åŠ¡çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
function saveTaskStatus(taskType, sector, status) {
    try {
        const taskData = {
            taskType: taskType,
            sector: sector,
            status: status,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(TASK_KEY_ANALYSIS, JSON.stringify(taskData));
        console.log('ä»»åŠ¡çŠ¶æ€å·²ä¿å­˜:', taskData);
    } catch (e) {
        console.error('ä¿å­˜ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
    }
}

// è·å–ä»»åŠ¡çŠ¶æ€
function getTaskStatus() {
    try {
        const stored = localStorage.getItem(TASK_KEY_ANALYSIS);
        if (stored) {
            return JSON.parse(stored);
        }
    } catch (e) {
        console.error('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
    }
    return null;
}

// æ¸…é™¤ä»»åŠ¡çŠ¶æ€
function clearTaskStatus() {
    try {
        localStorage.removeItem(TASK_KEY_ANALYSIS);
    } catch (e) {
        console.error('æ¸…é™¤ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
    }
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¹¶æ¢å¤ä»»åŠ¡çŠ¶æ€
function checkAndRestoreTaskStatus() {
    const taskStatus = getTaskStatus();
    if (taskStatus && taskStatus.status === 'running') {
        const sector = taskStatus.sector;
        console.log('æ£€æµ‹åˆ°æœªå®Œæˆçš„åˆ†æä»»åŠ¡:', sector);
        
        // æ¢å¤é€‰ä¸­çš„æ¿å—
        document.getElementById('analysisSector').value = sector;
        document.getElementById('analysisSelectedSectorText').textContent = sector;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('loadingSection').style.display = 'block';
        document.getElementById('loadingText').textContent = `æ­£åœ¨æ·±åº¦åˆ†æ ${sector}...`;
        
        // é‡æ–°æ‰§è¡Œåˆ†ææ“ä½œ
        startAnalysis(false, true);
    }
}

// æ ¼å¼åŒ–èµ„é‡‘æµå‘ï¼ˆä»¥ä¸‡ä¸ºå•ä½ï¼Œä¿ç•™2ä½å°æ•°ï¼‰
function formatFundFlow(value) {
    if (value === null || value === undefined || isNaN(value)) {
        return '0.00ä¸‡';
    }
    const wan = value / 10000;
    const sign = wan >= 0 ? '+' : '';
    return sign + wan.toFixed(2) + 'ä¸‡';
}

// æ ¼å¼åŒ–æ•°å­—ï¼ˆæ·»åŠ åƒåˆ†ä½åˆ†éš”ç¬¦ï¼Œä¿ç•™2ä½å°æ•°ï¼‰
function formatNumber(value, decimals = 2) {
    if (value === null || value === undefined || isNaN(value)) {
        return '--';
    }
    return value.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

// æ ¼å¼åŒ–ç™¾åˆ†æ¯”ï¼ˆä¿ç•™2ä½å°æ•°ï¼Œæ·»åŠ æ­£è´Ÿå·ï¼‰
function formatPercent(value, decimals = 2) {
    if (value === null || value === undefined || isNaN(value)) {
        return '--';
    }
    const sign = value >= 0 ? '+' : '';
    return sign + value.toFixed(decimals) + '%';
}

// ä¿å­˜åˆ†æç»“æœåˆ°æœ¬åœ°ç¼“å­˜ï¼ˆæŒä¹…åŒ–ç¼“å­˜ï¼Œä¸æŒ‰æ—¥æœŸæ¸…ç†ï¼‰
function saveAnalysisCache(sector, data) {
    try {
        const cacheData = {
            timestamp: new Date().toISOString(),
            sector: sector,
            prediction: data.prediction,
            features: data.features,
            train_result: data.train_result
        };
        localStorage.setItem(CACHE_KEY_ANALYSIS, JSON.stringify(cacheData));
        console.log('åˆ†æç»“æœå·²ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜');
    } catch (e) {
        console.error('ä¿å­˜ç¼“å­˜å¤±è´¥:', e);
    }
}

// ä»æœ¬åœ°ç¼“å­˜æ¢å¤åˆ†æç»“æœï¼ˆæŒä¹…åŒ–æ¢å¤ï¼Œä¸æ£€æŸ¥æ—¥æœŸï¼‰
function restoreAnalysisCache() {
    try {
        const cached = localStorage.getItem(CACHE_KEY_ANALYSIS);
        if (cached) {
            const cacheData = JSON.parse(cached);
            if (cacheData.prediction) {
                return cacheData;
            }
        }
    } catch (e) {
        console.error('æ¢å¤ç¼“å­˜å¤±è´¥:', e);
    }
    return null;
}

// æ¸…é™¤åˆ†æç¼“å­˜
function clearAnalysisCache() {
    try {
        localStorage.removeItem(CACHE_KEY_ANALYSIS);
        console.log('åˆ†æç¼“å­˜å·²æ¸…é™¤');
    } catch (e) {
        console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', e);
    }
}

// é¡µé¢åŠ è½½æ—¶å°è¯•æ¢å¤ç¼“å­˜
document.addEventListener('DOMContentLoaded', function() {
    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡
    checkAndRestoreTaskStatus();
    
    // ç„¶åå°è¯•æ¢å¤ç¼“å­˜ï¼ˆåªæœ‰åœ¨æ²¡æœ‰æœªå®Œæˆä»»åŠ¡æ—¶æ‰æ¢å¤ç¼“å­˜ï¼‰
    const taskStatus = getTaskStatus();
    if (!taskStatus || taskStatus.status !== 'running') {
        const cached = restoreAnalysisCache();
        if (cached) {
            // æ¢å¤é€‰ä¸­çš„æ¿å—
            document.getElementById('analysisSector').value = cached.sector;
            document.getElementById('analysisSelectedSectorText').textContent = cached.sector;
            // æ˜¾ç¤ºç¼“å­˜çš„ç»“æœ
            displayAnalysis(cached.prediction, cached.features, cached.train_result);
            
            // æ˜¾ç¤ºç¼“å­˜æ—¶é—´
            const cacheTime = new Date(cached.timestamp);
            console.log(`å·²æ¢å¤ä¸Šæ¬¡çš„æ·±åº¦åˆ†æç»“æœï¼ˆç¼“å­˜æ—¶é—´: ${cacheTime.toLocaleString()}ï¼‰`);
        }
    }
});

// ä¸‹æ‹‰æ¡†æ§åˆ¶
function toggleAnalysisSectorDropdown() {
    const menu = document.getElementById('analysisSectorDropdownMenu');
    const icon = document.getElementById('analysisSectorDropdownIcon');
    if (menu.style.display === 'none') {
        menu.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
        // æ¸…ç©ºæœç´¢æ¡†
        document.getElementById('analysisSectorSearchInput').value = '';
        filterAnalysisSectors('');
    } else {
        menu.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

// æœç´¢è¿‡æ»¤æ¿å—
function filterAnalysisSectors(keyword) {
    const items = document.querySelectorAll('.analysis-sector-item');
    const lowerKeyword = keyword.toLowerCase();
    items.forEach(item => {
        const sectorName = item.dataset.sector.toLowerCase();
        if (sectorName.includes(lowerKeyword)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// ç‚¹å‡»å¤–éƒ¨æ”¶èµ·ä¸‹æ‹‰æ¡†
document.addEventListener('click', function(event) {
    const container = document.getElementById('analysisSectorDropdownContainer');
    const menu = document.getElementById('analysisSectorDropdownMenu');
    const icon = document.getElementById('analysisSectorDropdownIcon');
    
    if (container && !container.contains(event.target)) {
        menu.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
});

// é€‰æ‹©æ¿å—
function selectAnalysisSector(sector) {
    document.getElementById('analysisSector').value = sector;
    document.getElementById('analysisSelectedSectorText').textContent = sector;
    document.getElementById('analysisSectorDropdownMenu').style.display = 'none';
    document.getElementById('analysisSectorDropdownIcon').className = 'fas fa-chevron-down';
}

function searchSectors(query, type = 'sector') {
    const items = document.querySelectorAll(`.${type}-item`);
    const searchTerm = query.toLowerCase().trim();
    
    items.forEach(item => {
        const sector = item.textContent.trim().toLowerCase();
        if (sector.includes(searchTerm)) {
            item.style.display = 'block';
            item.style.backgroundColor = sector === searchTerm ? 'rgba(0, 255, 255, 0.2)' : 'transparent';
        } else {
            item.style.display = 'none';
        }
    });
}

function clearSearch(type = 'sector') {
    const searchInput = document.getElementById(`${type}Search`);
    searchInput.value = '';
    const items = document.querySelectorAll(`.${type}-item`);
    items.forEach(item => {
        item.style.display = 'block';
        item.style.backgroundColor = 'transparent';
    });
}

function startAnalysis(force_refresh = false, isRestore = false) {
    const sector = document.getElementById('analysisSector').value;
    
    if (!sector) {
        alert('è¯·é€‰æ‹©ä¸€ä¸ªæ¿å—');
        return;
    }
    
    // å¦‚æœä¸æ˜¯æ¢å¤æ“ä½œï¼Œåˆ™ä¿å­˜ä»»åŠ¡çŠ¶æ€
    if (!isRestore) {
        saveTaskStatus('analysis', sector, 'running');
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('loadingText').textContent = force_refresh ? `æ­£åœ¨é‡æ–°åˆ†æ ${sector}...` : `æ­£åœ¨æ·±åº¦åˆ†æ ${sector}...`;
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('detailSection').style.display = 'none';
    document.getElementById('trainResultSection').style.display = 'none';
    document.getElementById('marketSection').style.display = 'none';
    
    fetch('/api/analysis/full', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sector, force_refresh})
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loadingSection').style.display = 'none';
        
        if (data.success) {
            clearTaskStatus(); // æ¸…é™¤ä»»åŠ¡çŠ¶æ€
            displayAnalysis(data.prediction, data.features, data.train_result);
            // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
            saveAnalysisCache(sector, data);
            // æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
            if (data.from_cache) {
                console.log('æ•°æ®æ¥è‡ªæœåŠ¡ç«¯ç¼“å­˜');
            }
        } else {
            clearTaskStatus(); // æ¸…é™¤ä»»åŠ¡çŠ¶æ€
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('loadingSection').innerHTML = `
                <div class="card">
                    <div class="card-body text-center py-5 text-danger">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h5>åˆ†æå¤±è´¥</h5>
                        <p>${data.error || 'æœªçŸ¥é”™è¯¯'}</p>
                    </div>
                </div>
            `;
        }
    })
    .catch(error => {
        clearTaskStatus(); // æ¸…é™¤ä»»åŠ¡çŠ¶æ€
        document.getElementById('loadingSection').style.display = 'block';
        document.getElementById('loadingSection').innerHTML = `
            <div class="card">
                <div class="card-body text-center py-5 text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5>ç½‘ç»œé”™è¯¯</h5>
                    <p>${error.message}</p>
                </div>
            </div>
        `;
    });
}

// å¼ºåˆ¶é‡æ–°åˆ†æ
function refreshAnalysis() {
    startAnalysis(true);
}

function displayAnalysis(prediction, features, trainResult) {
    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    document.getElementById('resultSection').style.display = 'block';
    document.getElementById('marketSection').style.display = 'block';
    document.getElementById('detailSection').style.display = 'block';
    document.getElementById('trainResultSection').style.display = 'block';
    
    // æ˜¾ç¤ºé¢„æµ‹æ—¥æœŸ
    if (prediction.prediction_date) {
        document.getElementById('analysisTargetDate').textContent = prediction.prediction_date;
    }
    if (prediction.base_date) {
        document.getElementById('analysisBaseDate').textContent = prediction.base_date;
    }
    
    // æ˜¾ç¤ºäº¤æ˜“ä¿¡å·åˆ†æ
    if (prediction.signal_analysis) {
        document.getElementById('signalAnalysisContent').innerHTML = prediction.signal_analysis;
    }
    
    // é¢„æµ‹ç»“æœ
    const prob = prediction.probability ?? 0;
    const ret = prediction.predicted_return ?? 0;
    
    document.getElementById('probValue').textContent = (prob * 100).toFixed(1) + '%';
    
    const probBar = document.getElementById('probBar');
    probBar.style.width = (prob * 100) + '%';
    probBar.className = 'probability-fill ' + 
        (ret > 0 ? 'probability-high' : ret < 0 ? 'probability-medium' : 'probability-low');
    document.getElementById('returnValue').textContent = (ret >= 0 ? '+' : '') + Number(ret).toFixed(2) + '%';
    document.getElementById('returnValue').className = 'h4 ' + (ret >= 0 ? 'text-up' : 'text-down');
    
    document.getElementById('signalValue').textContent = prediction.signal;
    document.getElementById('signalValue').className = 'h4 ' + 
        (prediction.signal === 'ä¹°å…¥' ? 'text-success' : prediction.signal === 'å–å‡º' ? 'text-danger' : 'text-warning');
    

    
    // å¸‚åœºæ•°æ®
    if (features) {
        // æ”¶ç›˜ä»· - æ·»åŠ åƒåˆ†ä½åˆ†éš”ç¬¦
        const closePrice = features.close || 0;
        document.getElementById('closePrice').textContent = formatNumber(closePrice);
        document.getElementById('closePrice').className = 'market-metric-value text-neutral';
        
        // å½“æ—¥æ¶¨è·Œ - é¢œè‰²åŒºåˆ†æ¶¨è·Œ
        const dailyChange = features.change_pct || 0;
        const dailyChangeEl = document.getElementById('dailyChange');
        dailyChangeEl.textContent = formatPercent(dailyChange);
        dailyChangeEl.className = 'market-metric-value ' + (dailyChange > 0 ? 'text-up' : dailyChange < 0 ? 'text-down' : 'text-neutral');
        
        // èµ„é‡‘æµå‘ - ä»¥ä¸‡ä¸ºå•ä½
        const inflow = features.net_inflow || 0;
        const netInflowEl = document.getElementById('netInflow');
        netInflowEl.textContent = formatFundFlow(inflow);
        netInflowEl.className = 'market-metric-value ' + (inflow > 0 ? 'text-up' : inflow < 0 ? 'text-down' : 'text-neutral');
        
        // æˆäº¤é‡å˜åŒ–
        const volChange = features.volume_change_rate || 0;
        const volChangeEl = document.getElementById('volumeChange');
        volChangeEl.textContent = formatPercent(volChange);
        volChangeEl.className = 'market-metric-value ' + (volChange > 0 ? 'text-up' : volChange < 0 ? 'text-down' : 'text-neutral');
    }
    
    // æŠ€æœ¯æŒ‡æ ‡è¡¨æ ¼
    if (features) {
        // ä»·æ ¼ç‰¹å¾
        document.getElementById('priceFeatures').innerHTML = `
            <tr><td>å½“æ—¥æ¶¨è·Œ</td><td>${((features.change_pct ?? 0)).toFixed(2)}%</td></tr>
            <tr><td>5æ—¥æ¶¨è·Œ</td><td>${((features.return_5d ?? 0)).toFixed(2)}%</td></tr>
            <tr><td>10æ—¥æ¶¨è·Œ</td><td>${((features.return_10d ?? 0)).toFixed(2)}%</td></tr>
            <tr><td>20æ—¥æ¶¨è·Œ</td><td>${((features.return_20d ?? 0)).toFixed(2)}%</td></tr>
            <tr><td>MA20ä½ç½®</td><td>${((features.ma20_position ?? 0)).toFixed(2)}</td></tr>
            <tr><td>å‡çº¿ä¿¡å·</td><td>${features.ma5_cross_ma20 || '--'}</td></tr>
        `;
        
        // èµ„é‡‘ç‰¹å¾
        document.getElementById('fundFeatures').innerHTML = `
            <tr><td>èµ„é‡‘å‡€æµå…¥</td><td>${formatFundFlow(features.net_inflow)}</td></tr>
            <tr><td>æµå…¥ç‡</td><td>${((features.net_inflow_rate ?? 0)).toFixed(2)}%</td></tr>
            <tr><td>5æ—¥ç´¯è®¡</td><td>${formatFundFlow(features.net_inflow_5d)}</td></tr>
            <tr><td>10æ—¥ç´¯è®¡</td><td>${formatFundFlow(features.net_inflow_10d)}</td></tr>
        `;
        
        // åŠ¨é‡ç‰¹å¾
        document.getElementById('momentumFeatures').innerHTML = `
            <tr><td>RSI(6)</td><td>${((features.rsi_6 ?? 0)).toFixed(2)}</td></tr>
            <tr><td>RSI(12)</td><td>${((features.rsi_12 ?? 0)).toFixed(2)}</td></tr>
            <tr><td>RSI(14)</td><td>${((features.rsi_14 ?? 0)).toFixed(2)}</td></tr>
            <tr><td>MACD</td><td>${((features.macd ?? 0)).toFixed(4)}</td></tr>
            <tr><td>MACDä¿¡å·</td><td>${((features.macd_signal ?? 0)).toFixed(4)}</td></tr>
            <tr><td>MACDæŸ±</td><td>${((features.macd_histogram ?? 0)).toFixed(4)}</td></tr>
            <tr><td>å¸ƒæ—ä½ç½®</td><td>${((features.bb_position ?? 0)).toFixed(2)}</td></tr>
        `;
        
        // æˆäº¤é‡ç‰¹å¾
        document.getElementById('volumeFeatures').innerHTML = `
            <tr><td>æˆäº¤é‡å˜åŒ–</td><td>${((features.volume_change_rate ?? 0)).toFixed(2)}%</td></tr>
            <tr><td>5æ—¥å‡é‡</td><td>${((features.volume_ma5 ?? 0)).toFixed(0)}</td></tr>
            <tr><td>20æ—¥å‡é‡</td><td>${((features.volume_ma20 ?? 0)).toFixed(0)}</td></tr>
            <tr><td>é‡ä»·é…åˆ</td><td>${((features.price_volume_match ?? 0)).toFixed(2)}</td></tr>
            <tr><td>OBV</td><td>${((features.obv ?? 0)).toFixed(0)}</td></tr>
        `;
    }
    
    // è®­ç»ƒç»“æœ
    if (trainResult) {
        document.getElementById('trainResultContent').textContent = JSON.stringify(trainResult, null, 2);
    }
}
</script>
{% endblock %}
