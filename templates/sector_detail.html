{% extends "base.html" %}

{% block title %}板块详情 - FinSectorForecast{% endblock %}

{% block extra_css %}
<style>
/* ==================== 页面整体布局 ==================== */
.sector-detail-container {
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 120px);
    padding: 1.5rem;
    padding-bottom: 50px;
}

/* ==================== 通用卡片样式（参考主页） ==================== */
.detail-card {
    background: linear-gradient(145deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 50%, rgba(255,255,255,0.01) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 4px 16px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255,255,255,0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    margin-bottom: 1.5rem;
}

.detail-card:hover {
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), 0 12px 48px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255,255,255,0.15);
    transform: translateY(-2px);
    border-color: rgba(255,255,255,0.15);
}

.detail-card .card-header {
    background: rgba(77, 163, 255, 0.1);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    border-radius: 16px 16px 0 0;
    padding: 1rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.detail-card .card-title {
    margin-bottom: 0;
    color: #4da3ff;
    font-weight: 600;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.detail-card .card-body {
    padding: 1.25rem;
}

/* ==================== 页面头部 ==================== */
.sector-header {
    background: linear-gradient(145deg, rgba(77, 163, 255, 0.15) 0%, rgba(77, 163, 255, 0.08) 50%, rgba(77, 163, 255, 0.02) 100%);
    border: 1px solid rgba(77, 163, 255, 0.2);
    border-radius: 20px;
    padding: 2rem 2.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 8px 32px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255,255,255,0.15);
}

.sector-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 0.5rem;
}

.sector-header .subtitle {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1rem;
}

.sector-header .subtitle .tag {
    background: rgba(77, 163, 255, 0.2);
    color: #4da3ff;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-right: 0.5rem;
}

/* ==================== 核心指标卡片区域 ==================== */
.metrics-section .metric-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

.metric-card {
    background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 50%, rgba(255,255,255,0.02) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 16px;
    padding: 1.25rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 8px 32px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255,255,255,0.15);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border-color: rgba(77, 163, 255, 0.3);
}

.metric-card .metric-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

.metric-card .metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #fff;
}

.metric-card .metric-change {
    font-size: 0.9rem;
    margin-top: 0.5rem;
}

.metric-card .metric-change.positive {
    color: #ff4d4f;
}

.metric-card .metric-change.negative {
    color: #52c41a;
}

/* ==================== 预测和风险区域 ==================== */
.prediction-risk-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

/* 预测结果卡片 */
.prediction-card {
    background: linear-gradient(145deg, rgba(77, 163, 255, 0.15) 0%, rgba(77, 163, 255, 0.08) 50%, rgba(77, 163, 255, 0.02) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(77, 163, 255, 0.2);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 8px 32px rgba(0, 0, 0, 0.08);
}

.prediction-card h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #4da3ff;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.prediction-value {
    font-size: 2.5rem;
    font-weight: 700;
    text-align: center;
    margin: 1rem 0;
}

.prediction-value.positive {
    color: #ff4d4f;
}

.prediction-value.negative {
    color: #52c41a;
}

.prediction-stats {
    display: flex;
    justify-content: space-around;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.prediction-stats .stat-item {
    text-align: center;
}

.prediction-stats .stat-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
}

.prediction-stats .stat-value {
    color: #fff;
    font-weight: 600;
    font-size: 1.1rem;
}

/* 风险评估卡片 */
.risk-card {
    background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 50%, rgba(255,255,255,0.02) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 8px 32px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255,255,255,0.15);
}

.risk-card h3 {
    font-size: 1.1rem;
    font-weight: 600;
    color: #fff;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.risk-level {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.risk-level .risk-value {
    font-size: 3rem;
    font-weight: 700;
}

.risk-level.low .risk-value {
    color: #52c41a;
}

.risk-level.medium .risk-value {
    color: #ffd43b;
}

.risk-level.high .risk-value {
    color: #ff4d4f;
}

.risk-level .risk-info .risk-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
}

.risk-level .risk-info .risk-text {
    color: #fff;
    font-weight: 600;
    font-size: 1.1rem;
}

/* ==================== 图表区域 ==================== */
.chart-container-detail {
    position: relative;
    height: 350px;
    margin: 1rem 0;
}

/* ==================== 技术指标卡片 - 块状展示 ==================== */
.indicators-cards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
}

.indicator-card {
    background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 50%, rgba(255,255,255,0.02) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 16px;
    padding: 1.25rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 8px 32px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255,255,255,0.15);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.indicator-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border-color: rgba(77, 163, 255, 0.3);
}

.indicator-card .card-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.indicator-card .indicator-name {
    font-weight: 600;
    font-size: 0.95rem;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.indicator-card .indicator-value {
    font-weight: 700;
    font-size: 1.3rem;
    color: #4da3ff;
}

.indicator-card .card-bottom {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.indicator-card .trend-info,
.indicator-card .signal-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.indicator-card .trend-label,
.indicator-card .signal-label {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.8rem;
}

/* 趋势和信号标签样式 */
.indicator-trend {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.25rem 0.6rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
}

.indicator-trend.positive {
    background: rgba(82, 196, 26, 0.15);
    color: #52c41a;
}

.indicator-trend.negative {
    background: rgba(255, 77, 79, 0.15);
    color: #ff4d4f;
}

.indicator-trend.neutral {
    background: rgba(255, 212, 59, 0.15);
    color: #ffd43b;
}

.indicator-signal {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.25rem 0.6rem;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 500;
}

.indicator-signal.buy {
    background: rgba(82, 196, 26, 0.2);
    color: #52c41a;
}

.indicator-signal.sell {
    background: rgba(255, 77, 79, 0.2);
    color: #ff4d4f;
}

.indicator-signal.hold {
    background: rgba(255, 212, 59, 0.2);
    color: #ffd43b;
}

/* ==================== 成分股列表 ==================== */
.components-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
}

.component-item {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.2s;
    cursor: pointer;
}

.component-item:hover {
    background: rgba(77, 163, 255, 0.1);
    border-color: rgba(77, 163, 255, 0.3);
    transform: translateY(-2px);
}

.component-name {
    font-weight: 600;
    color: #fff;
    font-size: 1rem;
}

.component-code {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.8rem;
}

.component-item .component-price {
    font-weight: 700;
    font-size: 1.2rem;
    color: #fff;
    margin: 0.5rem 0 0.25rem 0;
}

.component-change {
    font-weight: 600;
    font-size: 0.95rem;
}

.component-change.positive {
    color: #ff4d4f;
}

.component-change.negative {
    color: #52c41a;
}

/* ==================== 历史表现 ==================== */
.history-cards {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
}

.history-card-item {
    background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.04) 50%, rgba(255,255,255,0.02) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 16px;
    padding: 1.25rem;
    text-align: center;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.history-card-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    border-color: rgba(77, 163, 255, 0.3);
}

.history-card-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
}

.history-card-header i {
    color: #4da3ff;
}

.history-card-value {
    font-size: 1.8rem;
    font-weight: 700;
}

.history-card-value.positive {
    color: #ff4d4f;
}

.history-card-value.negative {
    color: #52c41a;
}

/* ==================== 标签页样式 ==================== */
.tabs-container {
    margin-bottom: 1.5rem;
}

.tabs-nav {
    display: flex;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    padding: 0.5rem;
    border-radius: 12px;
    margin-bottom: 1rem;
}

.tab-btn {
    flex: 1;
    padding: 0.75rem 1.25rem;
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.tab-btn:hover {
    color: #fff;
    background: rgba(255, 255, 255, 0.05);
}

.tab-btn.active {
    background: #4da3ff;
    color: #fff;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ==================== 信号标签样式 ==================== */
.signal-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.8rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
}

.signal-badge.buy {
    background: rgba(82, 196, 26, 0.2);
    color: #52c41a;
}

.signal-badge.strong-buy {
    background: rgba(82, 196, 26, 0.3);
    color: #52c41a;
}

.signal-badge.sell {
    background: rgba(255, 77, 79, 0.2);
    color: #ff4d4f;
}

.signal-badge.strong-sell {
    background: rgba(255, 77, 79, 0.3);
    color: #ff4d4f;
}

.signal-badge.hold {
    background: rgba(255, 212, 59, 0.2);
    color: #ffd43b;
}

/* ==================== 底部操作栏 ==================== */
.action-bar {
    display: flex;
    justify-content: center;
    gap: 1rem;
    padding: 1rem 0;
    margin-top: auto;
}

.action-bar .btn {
    padding: 0.75rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
}

.btn-primary {
    background: linear-gradient(135deg, #4da3ff, #0066cc);
    border: none;
    box-shadow: 0 4px 15px rgba(77, 163, 255, 0.3);
}

.btn-primary:hover {
    background: linear-gradient(135deg, #5db3ff, #0077e6);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(77, 163, 255, 0.4);
}

.btn-outline-light {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.3);
    color: #fff;
}

.btn-outline-light:hover {
    background: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.5);
    color: #fff;
}

/* ==================== 加载状态 ==================== */
.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    color: rgba(255,255,255,0.7);
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(77, 163, 255, 0.2);
    border-top-color: #4da3ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 1rem;
    font-size: 1rem;
}

/* ==================== 错误提示 ==================== */
.error-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    color: #ff4d4f;
}

.error-container i {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.error-container h3 {
    color: #fff;
    margin-bottom: 0.5rem;
}

/* ==================== 响应式设计 ==================== */
@media (max-width: 1200px) {
    .metrics-section .metric-cards {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .prediction-risk-section {
        grid-template-columns: 1fr;
    }
    
    .history-cards {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .sector-detail-container {
        padding: 1rem;
    }
    
    .sector-header {
        padding: 1.5rem;
    }
    
    .sector-header h1 {
        font-size: 1.5rem;
    }
    
    .metrics-section .metric-cards {
        grid-template-columns: 1fr;
    }
    
    .chart-container-detail {
        height: 280px;
    }
    
    .components-grid {
        grid-template-columns: 1fr;
    }
    
    .history-cards {
        grid-template-columns: 1fr;
    }
    
    .action-bar {
        flex-direction: column;
    }
    
    .action-bar .btn {
        width: 100%;
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="sector-detail-container" id="mainContent">
    <!-- 加载状态 -->
    <div class="loading-container" id="loadingState">
        <div class="loading-spinner"></div>
        <div class="loading-text">正在加载板块数据...</div>
    </div>
    
    <!-- 错误提示 -->
    <div class="error-container" id="errorState" style="display: none;">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>加载失败</h3>
        <p id="errorMessage">请稍后重试</p>
        <button class="btn btn-primary mt-3" onclick="loadSectorData()">
            <i class="fas fa-redo me-2"></i>重新加载
        </button>
    </div>
    
    <!-- 数据内容 -->
    <div id="dataContent" style="display: none;">
        <!-- 页面头部 -->
        <div class="sector-header">
            <h1>
                <i class="fas fa-chart-line me-3" style="color: #4da3ff;"></i>
                <span id="sectorName">板块名称</span>
            </h1>
            <p class="subtitle">
                <span class="tag" id="sectorCode">板块：--</span>
                <span>预测日期：<span id="predictionDate">--</span></span>
            </p>
        </div>
        
        <!-- 核心指标卡片 -->
        <div class="metrics-section">
            <div class="metric-cards">
                <div class="metric-card">
                    <div class="metric-label">当前价格</div>
                    <div class="metric-value" id="currentPrice">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">涨跌幅</div>
                    <div class="metric-value" id="priceChange">--</div>
                    <div class="metric-change" id="changePercent">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">成交量</div>
                    <div class="metric-value" id="volume">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">换手率</div>
                    <div class="metric-value" id="turnover">--</div>
                </div>
            </div>
        </div>
        
        <!-- 预测和风险区域 -->
        <div class="prediction-risk-section">
            <!-- 预测结果 -->
            <div class="prediction-card">
                <h3>
                    <i class="fas fa-bullseye"></i>
                    次日涨跌幅预测
                </h3>
                <div class="prediction-value" id="predictionValue">--</div>
                <div style="text-align: center; margin-bottom: 1rem;">
                    <span class="signal-badge" id="signalBadge">--</span>
                </div>
                <div class="prediction-stats">
                    <div class="stat-item">
                        <div class="stat-label">预测概率</div>
                        <div class="stat-value" id="predictionProbability">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">交易信号</div>
                        <div class="stat-value" id="predictionSignal">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">置信度</div>
                        <div class="stat-value" id="confidenceBadge">--</div>
                    </div>
                </div>
            </div>
            
            <!-- 风险评估 -->
            <div class="risk-card">
                <h3>
                    <i class="fas fa-shield-alt"></i>
                    风险评估
                </h3>
                <div class="risk-level" id="riskLevel">
                    <div class="risk-value">--</div>
                    <div class="risk-info">
                        <div class="risk-label">风险等级</div>
                        <div class="risk-text" id="riskDesc">--</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 标签页导航 -->
        <div class="tabs-container">
            <div class="tabs-nav">
                <button class="tab-btn active" data-tab="chart">价格走势</button>
                <button class="tab-btn" data-tab="indicators">技术指标</button>
                <button class="tab-btn" data-tab="components">成分股</button>
                <button class="tab-btn" data-tab="history">历史表现</button>
            </div>
            
            <!-- 价格走势 -->
            <div class="tab-content active" id="chart">
                <div class="detail-card">
                    <div class="card-header">
                        <span class="card-title">
                            <i class="fas fa-chart-area"></i>
                            价格趋势
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="chart-container-detail">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 技术指标 -->
            <div class="tab-content" id="indicators">
                <div class="detail-card">
                    <div class="card-header">
                        <span class="card-title">
                            <i class="fas fa-list-ol"></i>
                            技术指标分析
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="indicators-cards" id="indicatorsCards">
                            <div class="text-center py-3" style="grid-column: 1/-1;">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                <span class="ms-2 text-muted">正在加载指标数据...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 成分股 -->
            <div class="tab-content" id="components">
                <div class="detail-card">
                    <div class="card-header">
                        <span class="card-title">
                            <i class="fas fa-layer-group"></i>
                            成分股列表
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="components-grid" id="componentsList">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                <span class="ms-2 text-muted">正在加载成分股数据...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 历史表现 -->
            <div class="tab-content" id="history">
                <div class="detail-card">
                    <div class="card-header">
                        <span class="card-title">
                            <i class="fas fa-clock"></i>
                            历史表现
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="history-cards">
                            <div class="history-card-item">
                                <div class="history-card-header">
                                    <i class="fas fa-calendar-week"></i>
                                    <span>近5日涨跌幅</span>
                                </div>
                                <div class="history-card-value" id="5dChange">--</div>
                            </div>
                            <div class="history-card-item">
                                <div class="history-card-header">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>近10日涨跌幅</span>
                                </div>
                                <div class="history-card-value" id="10dChange">--</div>
                            </div>
                            <div class="history-card-item">
                                <div class="history-card-header">
                                    <i class="fas fa-calendar"></i>
                                    <span>近30日涨跌幅</span>
                                </div>
                                <div class="history-card-value" id="30dChange">--</div>
                            </div>
                            <div class="history-card-item">
                                <div class="history-card-header">
                                    <i class="fas fa-chart-line"></i>
                                    <span>今年以来涨跌幅</span>
                                </div>
                                <div class="history-card-value" id="yearChange">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 返回按钮 -->
        <div class="action-bar">
            <button class="btn btn-outline-light" onclick="window.location.href='/?highlight=' + encodeURIComponent(currentSectorCode)">
                <i class="fas fa-arrow-left"></i>
                返回首页
            </button>
            <button class="btn btn-primary" onclick="refreshData()">
                <i class="fas fa-sync-alt"></i>
                刷新数据
            </button>
            <span id="lastRefreshTime" style="align-self: center; color: rgba(255,255,255,0.6); font-size: 0.9rem; margin-left: 1rem;"></span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// 全局变量
let priceChart = null;
let currentSectorCode = '';
let currentPriceData = [];

// 标签页切换
document.addEventListener('DOMContentLoaded', function() {
    // 标签页切换
    const tabBtns = document.querySelectorAll('.tab-btn');
    tabBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const tabId = this.dataset.tab;
            
            // 更新按钮状态
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // 更新内容显示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
        });
    });
    
    // 获取URL参数中的板块代码或名称
    const urlParams = new URLSearchParams(window.location.search);
    const sectorCode = urlParams.get('code');
    let sectorId = urlParams.get('id');
    const sectorName = urlParams.get('name');
    
    // 如果URL中没有ID，根据板块名称生成一个ID
    if (!sectorId && sectorName) {
        // 使用名称的hashcode作为ID
        let hash = 0;
        for (let i = 0; i < sectorName.length; i++) {
            hash = ((hash << 5) - hash) + sectorName.charCodeAt(i);
            hash = hash & hash;
        }
        sectorId = Math.abs(hash) % 1000;
    }
    
    // 显示板块ID
    if (sectorId) {
        document.getElementById('sectorCode').textContent = '板块ID: ' + sectorId;
    }
    
    if (sectorCode) {
        currentSectorCode = sectorCode;
        loadSectorData(sectorCode);
    } else if (sectorName) {
        currentSectorCode = sectorName;
        loadSectorDataByName(sectorName, sectorId);
    } else {
        showError('未找到板块信息');
    }
});

// 根据代码加载数据
function loadSectorData(sectorCode) {
    fetch('/api/sector/detail?name=' + encodeURIComponent(sectorCode))
        .then(function(response) { 
            return response.json(); 
        })
        .then(function(data) {
            if (data.success) {
                renderSectorData(data.data, null);
            } else {
                showError(data.error || '加载数据失败');
            }
        })
        .catch(function(error) {
            console.error('加载板块数据失败:', error);
            showError('网络请求失败，请稍后重试');
        });
}

// 根据名称加载数据
function loadSectorDataByName(sectorName, sectorId) {
    // 同时传递ID参数
    var url = '/api/sector/detail?name=' + encodeURIComponent(sectorName);
    if (sectorId) {
        url = url + '&id=' + sectorId;
    }
    fetch(url)
        .then(function(response) { 
            return response.json(); 
        })
        .then(function(data) {
            if (data.success) {
                renderSectorData(data.data, sectorId);
            } else {
                showError(data.error || '加载数据失败');
            }
        })
        .catch(function(error) {
            console.error('加载板块数据失败:', error);
            showError('网络请求失败，请稍后重试');
        });
}

// 渲染板块数据
function renderSectorData(data, displayId) {
    // 隐藏加载状态，显示数据内容
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('dataContent').style.display = 'block';
    
    // 页面头部 - 显示板块名称和ID
    if (!displayId) {
        displayId = data.id;
    }
    var displayText = data.name;
    if (displayId) {
        displayText = displayText + ' <span class="badge bg-primary ms-2">ID: ' + displayId + '</span>';
    }
    document.getElementById('sectorName').innerHTML = displayText;
    // 如果有ID，显示ID
    if (displayId) {
        document.getElementById('sectorCode').textContent = '板块ID: ' + displayId;
    } else {
        document.getElementById('sectorCode').textContent = '板块：' + data.code;
    }
    document.getElementById('predictionDate').textContent = data.prediction_date || '--';
    
    // 核心指标
    document.getElementById('currentPrice').textContent = data.currentPrice || '--';
    document.getElementById('priceChange').textContent = data.priceChange || '--';
    document.getElementById('changePercent').textContent = data.changePercent || '';
    document.getElementById('volume').textContent = data.volume || '--';
    document.getElementById('turnover').textContent = data.turnover || '--';
    
    // 设置涨跌幅颜色
    const changePercent = document.getElementById('changePercent');
    if (data.priceChange && data.priceChange.startsWith('+')) {
        changePercent.classList.add('positive');
    } else if (data.priceChange && data.priceChange.startsWith('-')) {
        changePercent.classList.add('negative');
    }
    
    // 预测结果
    const predictionValue = document.getElementById('predictionValue');
    predictionValue.textContent = data.prediction || '--';
    if (data.prediction && data.prediction.startsWith('+')) {
        predictionValue.classList.add('positive');
    } else if (data.prediction && data.prediction.startsWith('-')) {
        predictionValue.classList.add('negative');
    }
    
    // 置信度和信号
    document.getElementById('confidenceBadge').textContent = data.confidence || '--';
    document.getElementById('predictionProbability').textContent = `${data.accuracy || '--'}%`;
    document.getElementById('predictionSignal').textContent = data.signal || '--';
    
    // 信号徽章
    const signalBadge = document.getElementById('signalBadge');
    const signal = data.signal || '';
    signalBadge.textContent = signal;
    signalBadge.className = 'signal-badge';
    if (signal.includes('买入')) {
        signalBadge.classList.add(signal.includes('强烈') ? 'strong-buy' : 'buy');
    } else if (signal.includes('卖出')) {
        signalBadge.classList.add(signal.includes('强烈') ? 'strong-sell' : 'sell');
    } else {
        signalBadge.classList.add('hold');
    }
    
    // 风险评估
    const riskLevel = document.getElementById('riskLevel');
    riskLevel.className = `risk-level ${data.riskLevel === '低' ? 'low' : (data.riskLevel === '高' ? 'high' : 'medium')}`;
    riskLevel.querySelector('.risk-value').textContent = data.riskLevel || '--';
    document.getElementById('riskDesc').textContent = data.riskDesc || '--';
    
    // 渲染技术指标
    renderIndicators(data.indicators || []);
    
    // 渲染成分股
    renderComponents(data.components || []);
    
    // 渲染历史表现
    renderHistory(data.history || {});
    
    // 创建价格趋势图表
    if (data.priceHistory && data.priceHistory.length > 0) {
        currentPriceData = data.priceHistory;
        createPriceChart(data.priceHistory);
    }
    
    // 更新最后刷新时间
    updateLastRefreshTime();
}

// 渲染技术指标 - 卡片式展示
function renderIndicators(indicators) {
    const container = document.getElementById('indicatorsCards');
    container.innerHTML = '';
    
    if (indicators.length === 0) {
        container.innerHTML = '<div class="text-center py-3 text-muted" style="grid-column: 1/-1;">暂无数据</div>';
        return;
    }
    
    indicators.forEach(indicator => {
        const card = document.createElement('div');
        card.className = 'indicator-card';
        card.innerHTML = `
            <div class="card-top">
                <span class="indicator-name">
                    <i class="fas fa-chart-line" style="color: #4da3ff;"></i>
                    ${indicator.name}
                </span>
            </div>
            <div class="indicator-value">${indicator.value}</div>
            <div class="card-bottom">
                <div class="trend-info">
                    <span class="trend-label">趋势</span>
                    <span class="indicator-trend ${indicator.trend}">${indicator.trendText}</span>
                </div>
                <div class="signal-info">
                    <span class="signal-label">信号</span>
                    <span class="indicator-signal ${indicator.signal}">${indicator.signalText}</span>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

// 渲染成分股
function renderComponents(components) {
    const list = document.getElementById('componentsList');
    list.innerHTML = '';
    
    if (components.length === 0) {
        list.innerHTML = '<div class="text-center py-3 text-muted">暂无数据</div>';
        return;
    }
    
    components.forEach(component => {
        const item = document.createElement('div');
        item.className = 'component-item';
        item.innerHTML = `
            <div class="component-name">${component.name}</div>
            <div class="component-code">${component.code}</div>
            <div class="component-price">${component.price}</div>
            <div class="component-change ${component.change.startsWith('+') ? 'positive' : 'negative'}">
                ${component.change}
            </div>
        `;
        list.appendChild(item);
    });
}

// 渲染历史表现
function renderHistory(history) {
    const setValue = (elementId, value) => {
        const el = document.getElementById(elementId);
        if (value && value.startsWith('+')) {
            el.classList.add('positive');
        } else if (value && value.startsWith('-')) {
            el.classList.add('negative');
        }
        el.textContent = value || '--';
    };
    
    setValue('5dChange', history['5d']);
    setValue('10dChange', history['10d']);
    setValue('30dChange', history['30d']);
    setValue('yearChange', history['year']);
}

// 创建价格趋势图表
function createPriceChart(priceHistory) {
    const ctx = document.getElementById('priceChart').getContext('2d');
    
    // 如果已存在图表，先销毁
    if (priceChart) {
        priceChart.destroy();
    }
    
    // 准备图表数据
    const labels = priceHistory.map(item => item.date);
    const prices = priceHistory.map(item => item.price);
    
    // 创建渐变背景
    const gradient = ctx.createLinearGradient(0, 0, 0, 350);
    gradient.addColorStop(0, 'rgba(77, 163, 255, 0.3)');
    gradient.addColorStop(1, 'rgba(77, 163, 255, 0)');
    
    // 创建图表
    priceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '价格',
                data: prices,
                borderColor: '#4da3ff',
                backgroundColor: gradient,
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 0,
                pointHoverRadius: 6,
                pointBackgroundColor: '#4da3ff',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(77, 163, 255, 0.5)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        title: function(context) {
                            return context[0].label;
                        },
                        label: function(context) {
                            return `价格: ${context.parsed.y.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        font: {
                            size: 11
                        },
                        maxTicksLimit: 8
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        font: {
                            size: 11
                        }
                    }
                }
            }
        }
    });
}

// 显示加载状态
function showLoading() {
    document.getElementById('loadingState').style.display = 'flex';
    document.getElementById('errorState').style.display = 'none';
    document.getElementById('dataContent').style.display = 'none';
}

// 显示错误状态
function showError(message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'flex';
    document.getElementById('dataContent').style.display = 'none';
    document.getElementById('errorMessage').textContent = message || '加载失败，请稍后重试';
}

// 刷新数据
function refreshData() {
    showLoading();
    if (currentSectorCode) {
        loadSectorData(currentSectorCode);
    }
}

// 返回首页
function goBack() {
    window.location.href = '/';
}

// ==================== 刷新时间显示 ====================
function updateLastRefreshTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const el = document.getElementById('lastRefreshTime');
    if (el) {
        el.textContent = `最后更新: ${timeStr}`;
    }
}
</script>
{% endblock %}
