 {% extends "base.html" %}

{% block title %}é¢„æµ‹åˆ†æ - FinSectorForecast{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="fas fa-chart-pie me-2 text-primary"></i>
            é¢„æµ‹åˆ†æ
        </h2>
    </div>
</div>

<!-- é€‰æ‹©é¢æ¿ -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card has-dropdown">
            <div class="card-header">
                <i class="fas fa-sliders-h me-2"></i>å‚æ•°è®¾ç½®
            </div>
            <div class="card-body" style="position: relative; overflow: visible;">
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">é€‰æ‹©æ¿å—ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <div class="dropdown" id="sectorDropdownContainer">
                            <button class="btn btn-outline-primary w-100 text-start d-flex justify-content-between align-items-center" 
                                    type="button" id="sectorDropdownBtn" onclick="toggleSectorDropdown()">
                                <span id="selectedSectorsText">è¯·é€‰æ‹©æ¿å—</span>
                                <i class="fas fa-chevron-down" id="sectorDropdownIcon"></i>
                            </button>
                            <div class="dropdown-menu w-100 p-3" id="sectorDropdownMenu" style="display: none; position: absolute; z-index: 9999; max-height: 400px; overflow-y: auto; top: 100%; left: 0;">
                                <div class="mb-2">
                                    <input type="text" class="form-control form-control-sm" id="sectorSearchInput" placeholder="æœç´¢æ¿å—..." oninput="filterSectors(this.value)" style="color: black !important;">
                                </div>
                                <div class="mb-2 d-flex gap-2 align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllSectors()">å…¨é€‰</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllSectors()">æ¸…ç©º</button>
                                    <button type="button" class="btn btn-sm btn-primary ms-auto" onclick="confirmSectorSelection()">ç¡®è®¤</button>
                                </div>
                                <hr class="my-2">
                                <div id="sectorCheckboxes">
                                    <div class="text-center py-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2 text-muted">æ­£åœ¨åŠ è½½æ¿å—åˆ—è¡¨...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-primary w-100 py-3" onclick="doPredict()">
                            <i class="fas fa-rocket me-1"></i>å¼€å§‹é¢„æµ‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é¢„æµ‹ç»“æœ -->
<div class="row" id="resultSection" style="display: none;">
    <!-- é¢„æµ‹æ—¥æœŸæ˜¾ç¤º -->
    <div class="col-12 mb-3">
        <div class="prediction-date">
            <span class="date-label">ğŸ“Š é¢„æµ‹ç›®æ ‡æ—¥æœŸï¼š</span>
            <span class="date-value" id="predictionTargetDate">--</span>
            <span class="ms-3 date-label">ï¼ˆåŸºäº <span id="predictionBaseDate">--</span> æ•°æ®ï¼‰</span>
        </div>
    </div>
    
    <!-- å¤šæ¿å—é¢„æµ‹ç»“æœè¡¨æ ¼ -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-table me-2"></i>é¢„æµ‹ç»“æœæ±‡æ€»
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-dark" id="predictionTable">
                        <thead>
                            <tr>
                                <th>æ¿å—åç§°</th>
                                <th>å‡†ç¡®ç‡</th>
                                <th>é¢„æµ‹æ¶¨å¹…</th>
                                <th>äº¤æ˜“ä¿¡å·</th>
                            </tr>
                        </thead>
                        <tbody id="predictionBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å•æ¿å—è¯¦ç»†ç»“æœ -->
<div class="row mt-4" id="detailSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-list-alt me-2"></i>è¯¦ç»†æŠ€æœ¯æŒ‡æ ‡ï¼ˆç‚¹å‡»è¡¨æ ¼è¡ŒæŸ¥çœ‹ï¼‰
            </div>
            <div class="card-body" id="detailBody">
                <p class="text-muted text-center">ç‚¹å‡»ä¸Šæ–¹è¡¨æ ¼ä¸­çš„è¡ŒæŸ¥çœ‹è¯¦ç»†æŒ‡æ ‡</p>
            </div>
        </div>
    </div>
</div>

<!-- åŠ è½½çŠ¶æ€ -->
<div class="row" id="loadingSection">
    <div class="col-12 text-center py-5">
        <div class="loading-spinner" style="width: 50px; height: 50px;"></div>
        <p class="mt-3 text-muted">è¯·é€‰æ‹©æ¿å—å¹¶ç‚¹å‡»é¢„æµ‹</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPredictions = [];
let selectedSectorsList = [];

// æœ¬åœ°ç¼“å­˜é”®å
const CACHE_KEY_PREDICT = 'predict_page_cache';

// ä»»åŠ¡çŠ¶æ€ç¼“å­˜é”®å
const TASK_KEY_PREDICT = 'predict_task_status';

// æ¿å—åˆ—è¡¨æœ¬åœ°ç¼“å­˜é”®å
const SECTORS_LOCAL_CACHE_KEY = 'sectors_local_cache';
const SECTORS_CACHE_TTL = 3600000; // 1å°æ—¶ï¼ˆæ¯«ç§’ï¼‰

// è·å–æœ¬åœ°ç¼“å­˜çš„æ¿å—åˆ—è¡¨
function getLocalSectorsCache() {
    try {
        const cached = localStorage.getItem(SECTORS_LOCAL_CACHE_KEY);
        if (cached) {
            const data = JSON.parse(cached);
            const now = Date.now();
            if (data.timestamp && (now - data.timestamp) < SECTORS_CACHE_TTL) {
                return data.sectors;
            }
        }
    } catch (e) {
        console.error('è¯»å–æœ¬åœ°æ¿å—ç¼“å­˜å¤±è´¥:', e);
    }
    return null;
}

// ä¿å­˜æ¿å—åˆ—è¡¨åˆ°æœ¬åœ°ç¼“å­˜
function saveLocalSectorsCache(sectors) {
    try {
        const data = {
            sectors: sectors,
            timestamp: Date.now()
        };
        localStorage.setItem(SECTORS_LOCAL_CACHE_KEY, JSON.stringify(data));
    } catch (e) {
        console.error('ä¿å­˜æœ¬åœ°æ¿å—ç¼“å­˜å¤±è´¥:', e);
    }
}

// å¼‚æ­¥åŠ è½½æ¿å—åˆ—è¡¨
async function loadPredictSectors() {
    const sectorListEl = document.getElementById('sectorCheckboxes');
    if (!sectorListEl) return;
    
    // å…ˆå°è¯•ä»æœ¬åœ°ç¼“å­˜è¯»å–
    const localSectors = getLocalSectorsCache();
    if (localSectors && localSectors.length > 0) {
        console.log('ä½¿ç”¨æœ¬åœ°ç¼“å­˜çš„æ¿å—åˆ—è¡¨');
        renderPredictSectors(localSectors);
        return;
    }
    
    // æœ¬åœ°ç¼“å­˜ä¸å­˜åœ¨æˆ–è¿‡æœŸï¼Œä»æœåŠ¡å™¨è·å–
    try {
        const response = await fetch('/api/sectors');
        const result = await response.json();
        
        if (result.success && result.data) {
            saveLocalSectorsCache(result.data);
            renderPredictSectors(result.data);
        } else {
            sectorListEl.innerHTML = '<div class="text-danger px-3">åŠ è½½å¤±è´¥</div>';
        }
    } catch (e) {
        console.error('åŠ è½½æ¿å—åˆ—è¡¨å¤±è´¥:', e);
        sectorListEl.innerHTML = '<div class="text-danger px-3">åŠ è½½å¤±è´¥: ' + e.message + '</div>';
    }
}

// æ¸²æŸ“æ¿å—åˆ—è¡¨
function renderPredictSectors(sectors) {
    const sectorListEl = document.getElementById('sectorCheckboxes');
    if (!sectorListEl) return;
    
    sectorListEl.innerHTML = sectors.map(sector => 
        `<div class="sector-item" data-sector="${sector}" onclick="toggleSectorItem(this, '${sector}')" style="cursor: pointer; padding: 8px 12px; border-radius: 4px; margin-bottom: 2px; background: transparent;">
            ${sector}
        </div>`
    ).join('');
}

// é¡µé¢åŠ è½½å®Œæˆåå¼‚æ­¥åŠ è½½æ¿å—åˆ—è¡¨
document.addEventListener('DOMContentLoaded', function() {
    loadPredictSectors();
});

// ä¿å­˜ä»»åŠ¡çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
function savePredictTaskStatus(sectors, status) {
    try {
        const taskData = {
            taskType: 'predict',
            sectors: sectors,
            status: status,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(TASK_KEY_PREDICT, JSON.stringify(taskData));
        console.log('é¢„æµ‹ä»»åŠ¡çŠ¶æ€å·²ä¿å­˜:', taskData);
    } catch (e) {
        console.error('ä¿å­˜é¢„æµ‹ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
    }
}

// è·å–ä»»åŠ¡çŠ¶æ€
function getPredictTaskStatus() {
    try {
        const stored = localStorage.getItem(TASK_KEY_PREDICT);
        if (stored) {
            return JSON.parse(stored);
        }
    } catch (e) {
        console.error('è·å–é¢„æµ‹ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
    }
    return null;
}

// æ¸…é™¤ä»»åŠ¡çŠ¶æ€
function clearPredictTaskStatus() {
    try {
        localStorage.removeItem(TASK_KEY_PREDICT);
    } catch (e) {
        console.error('æ¸…é™¤é¢„æµ‹ä»»åŠ¡çŠ¶æ€å¤±è´¥:', e);
    }
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¹¶æ¢å¤ä»»åŠ¡çŠ¶æ€
function checkAndRestorePredictTask() {
    const taskStatus = getPredictTaskStatus();
    if (taskStatus && taskStatus.status === 'running' && taskStatus.sectors) {
        const sectors = taskStatus.sectors;
        console.log('æ£€æµ‹åˆ°æœªå®Œæˆçš„é¢„æµ‹ä»»åŠ¡:', sectors);
        
        // æ¢å¤é€‰ä¸­çš„æ¿å—
        selectedSectorsList = sectors.slice();
        
        // æ›´æ–°UIæ˜¾ç¤º
        sectors.forEach(sector => {
            const item = document.querySelector(`.sector-item[data-sector="${sector}"]`);
            if (item) {
                item.dataset.selected = 'true';
                item.style.background = 'rgba(77, 163, 255, 0.2)';
            }
        });
        updateSelectedText();
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        document.getElementById('loadingSection').style.display = 'block';
        document.getElementById('loadingSection').innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="loading-spinner" style="width: 50px; height: 50px;"></div>
                <p class="mt-3 text-muted">æ­£åœ¨é¢„æµ‹ ${sectors.length} ä¸ªæ¿å—ï¼Œè¯·ç¨å€™...</p>
            </div>
        `;
        document.getElementById('resultSection').style.display = 'none';
        document.getElementById('detailSection').style.display = 'none';
        
        // é‡æ–°æ‰§è¡Œé¢„æµ‹æ“ä½œ
        doPredictRestore();
    }
}

// é‡æ–°æ‰§è¡Œé¢„æµ‹ï¼ˆæ¢å¤æ¨¡å¼ï¼‰
function doPredictRestore(force_refresh = false) {
    const selectedSectors = getSelectedSectors();
    
    if (selectedSectors.length === 0) {
        return;
    }
    
    fetch('/api/predict/multi', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sectors: selectedSectors, force_refresh: force_refresh})
    })
    .then(response => response.json())
    .then(data => {
        clearPredictTaskStatus();
        document.getElementById('loadingSection').style.display = 'none';
        
        if (data.success) {
            currentPredictions = data.predictions;
            displayPredictions(data.predictions);
            // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
            savePredictCache(data);
            // æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
            if (data.from_cache) {
                console.log('æ•°æ®æ¥è‡ªæœåŠ¡ç«¯ç¼“å­˜');
            }
        } else {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('loadingSection').innerHTML = `
                <div class="col-12 text-center py-5 text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <p>${data.error || 'é¢„æµ‹å¤±è´¥'}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        clearPredictTaskStatus();
        document.getElementById('loadingSection').style.display = 'block';
        document.getElementById('loadingSection').innerHTML = `
            <div class="col-12 text-center py-5 text-danger">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>ç½‘ç»œé”™è¯¯: ${error.message}</p>
            </div>
        `;
    });
}

// ä¿å­˜é¢„æµ‹ç»“æœåˆ°æœ¬åœ°ç¼“å­˜ï¼ˆæŒä¹…åŒ–ç¼“å­˜ï¼Œä¸æŒ‰æ—¥æœŸæ¸…ç†ï¼‰
function savePredictCache(data) {
    try {
        const cacheData = {
            timestamp: new Date().toISOString(),
            predictions: data.predictions,
            sectors: selectedSectorsList.slice()
        };
        localStorage.setItem(CACHE_KEY_PREDICT, JSON.stringify(cacheData));
        console.log('é¢„æµ‹ç»“æœå·²ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜');
    } catch (e) {
        console.error('ä¿å­˜ç¼“å­˜å¤±è´¥:', e);
    }
}

// ä»æœ¬åœ°ç¼“å­˜æ¢å¤é¢„æµ‹ç»“æœï¼ˆæŒä¹…åŒ–æ¢å¤ï¼Œä¸æ£€æŸ¥æ—¥æœŸï¼‰
function restorePredictCache() {
    try {
        const cached = localStorage.getItem(CACHE_KEY_PREDICT);
        if (cached) {
            const cacheData = JSON.parse(cached);
            if (cacheData.predictions && cacheData.predictions.length > 0) {
                return cacheData;
            }
        }
    } catch (e) {
        console.error('æ¢å¤ç¼“å­˜å¤±è´¥:', e);
    }
    return null;
}

// æ¸…é™¤é¢„æµ‹ç¼“å­˜
function clearPredictCache() {
    try {
        localStorage.removeItem(CACHE_KEY_PREDICT);
        console.log('é¢„æµ‹ç¼“å­˜å·²æ¸…é™¤');
    } catch (e) {
        console.error('æ¸…é™¤ç¼“å­˜å¤±è´¥:', e);
    }
}

// é¡µé¢åŠ è½½æ—¶å°è¯•æ¢å¤ç¼“å­˜
document.addEventListener('DOMContentLoaded', function() {
    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ä»»åŠ¡
    checkAndRestorePredictTask();
    
    // ç„¶åå°è¯•æ¢å¤ç¼“å­˜ï¼ˆåªæœ‰åœ¨æ²¡æœ‰æœªå®Œæˆä»»åŠ¡æ—¶æ‰æ¢å¤ç¼“å­˜ï¼‰
    const taskStatus = getPredictTaskStatus();
    if (!taskStatus || taskStatus.status !== 'running') {
        const cached = restorePredictCache();
        if (cached) {
            currentPredictions = cached.predictions;
            displayPredictions(cached.predictions);
            // æ¢å¤é€‰ä¸­çš„æ¿å—
            if (cached.sectors && cached.sectors.length > 0) {
                selectedSectorsList = cached.sectors;
                // æ›´æ–°UIæ˜¾ç¤º
                cached.sectors.forEach(sector => {
                    const item = document.querySelector(`.sector-item[data-sector="${sector}"]`);
                    if (item) {
                        item.dataset.selected = 'true';
                        item.style.background = 'rgba(77, 163, 255, 0.2)';
                    }
                });
                updateSelectedText();
            }
            
            // éšè—åŠ è½½çŠ¶æ€
            document.getElementById('loadingSection').style.display = 'none';
            
            // æ˜¾ç¤ºç¼“å­˜æ—¶é—´
            const cacheTime = new Date(cached.timestamp);
            console.log(`å·²æ¢å¤ä¸Šæ¬¡çš„é¢„æµ‹ç»“æœï¼ˆç¼“å­˜æ—¶é—´: ${cacheTime.toLocaleString()}ï¼‰`);
        }
    }
});

// ä¸‹æ‹‰æ¡†æ§åˆ¶
function toggleSectorDropdown() {
    const menu = document.getElementById('sectorDropdownMenu');
    const icon = document.getElementById('sectorDropdownIcon');
    if (menu.style.display === 'none') {
        menu.style.display = 'block';
        icon.className = 'fas fa-chevron-up';
        // æ¸…ç©ºæœç´¢æ¡†
        document.getElementById('sectorSearchInput').value = '';
        filterSectors('');
    } else {
        menu.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

// æœç´¢è¿‡æ»¤æ¿å—
function filterSectors(keyword) {
    const items = document.querySelectorAll('.sector-item');
    const lowerKeyword = keyword.toLowerCase();
    items.forEach(item => {
        const sectorName = item.dataset.sector.toLowerCase();
        if (sectorName.includes(lowerKeyword)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// ç‚¹å‡»å¤–éƒ¨æ”¶èµ·ä¸‹æ‹‰æ¡†
document.addEventListener('click', function(event) {
    const container = document.getElementById('sectorDropdownContainer');
    const menu = document.getElementById('sectorDropdownMenu');
    const icon = document.getElementById('sectorDropdownIcon');
    
    if (container && !container.contains(event.target)) {
        menu.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
});

// ç‚¹å‡»æ¿å—é¡¹åˆ‡æ¢é€‰ä¸­çŠ¶æ€
function toggleSectorItem(element, sector) {
    const isSelected = element.dataset.selected === 'true';
    if (isSelected) {
        element.dataset.selected = 'false';
        element.style.background = 'transparent';
        selectedSectorsList = selectedSectorsList.filter(s => s !== sector);
    } else {
        element.dataset.selected = 'true';
        element.style.background = 'rgba(77, 163, 255, 0.2)';
        selectedSectorsList.push(sector);
    }
}

// å…¨é€‰
function selectAllSectors() {
    document.querySelectorAll('.sector-item:not([style*="display: none"])').forEach(item => {
        item.dataset.selected = 'true';
        item.style.background = 'rgba(77, 163, 255, 0.2)';
    });
    selectedSectorsList = Array.from(document.querySelectorAll('.sector-item:not([style*="display: none"])')).map(item => item.textContent.trim());
}

// æ¸…ç©º
function clearAllSectors() {
    document.querySelectorAll('.sector-item').forEach(item => {
        item.dataset.selected = 'false';
        item.style.background = 'transparent';
    });
    selectedSectorsList = [];
}

// ç¡®è®¤é€‰æ‹©å¹¶æ”¶èµ·
function confirmSectorSelection() {
    updateSelectedText();
    const menu = document.getElementById('sectorDropdownMenu');
    const icon = document.getElementById('sectorDropdownIcon');
    menu.style.display = 'none';
    icon.className = 'fas fa-chevron-down';
}

// æ›´æ–°é€‰ä¸­æ¿å—æ˜¾ç¤º
function updateSelectedText() {
    const text = document.getElementById('selectedSectorsText');
    if (selectedSectorsList.length === 0) {
        text.textContent = 'è¯·é€‰æ‹©æ¿å—';
    } else if (selectedSectorsList.length <= 3) {
        text.textContent = selectedSectorsList.join(', ');
    } else {
        text.textContent = `å·²é€‰æ‹© ${selectedSectorsList.length} ä¸ªæ¿å—`;
    }
}

function getSelectedSectors() {
    return selectedSectorsList;
}

function doPredict(force_refresh = false) {
    const selectedSectors = getSelectedSectors();
    
    if (selectedSectors.length === 0) {
        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¿å—');
        return;
    }
    
    // ä¿å­˜ä»»åŠ¡çŠ¶æ€
    savePredictTaskStatus(selectedSectors, 'running');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    document.getElementById('loadingSection').style.display = 'block';
    document.getElementById('loadingSection').innerHTML = `
        <div class="col-12 text-center py-5">
            <div class="loading-spinner" style="width: 50px; height: 50px;"></div>
            <p class="mt-3 text-muted">${force_refresh ? 'æ­£åœ¨é‡æ–°é¢„æµ‹' : 'æ­£åœ¨é¢„æµ‹'} ${selectedSectors.length} ä¸ªæ¿å—ï¼Œè¯·ç¨å€™...</p>
        </div>
    `;
    document.getElementById('resultSection').style.display = 'none';
    document.getElementById('detailSection').style.display = 'none';
    
    fetch('/api/predict/multi', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({sectors: selectedSectors, force_refresh: force_refresh})
    })
    .then(response => response.json())
    .then(data => {
        clearPredictTaskStatus(); // æ¸…é™¤ä»»åŠ¡çŠ¶æ€
        document.getElementById('loadingSection').style.display = 'none';
        
        if (data.success) {
            currentPredictions = data.predictions;
            displayPredictions(data.predictions);
            // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
            savePredictCache(data);
            // æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
            if (data.from_cache) {
                console.log('æ•°æ®æ¥è‡ªæœåŠ¡ç«¯ç¼“å­˜');
            }
        } else {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('loadingSection').innerHTML = `
                <div class="col-12 text-center py-5 text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <p>${data.error || 'é¢„æµ‹å¤±è´¥'}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        clearPredictTaskStatus(); // æ¸…é™¤ä»»åŠ¡çŠ¶æ€
        document.getElementById('loadingSection').style.display = 'block';
        document.getElementById('loadingSection').innerHTML = `
            <div class="col-12 text-center py-5 text-danger">
                <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                <p>ç½‘ç»œé”™è¯¯: ${error.message}</p>
            </div>
        `;
    });
}

function displayPredictions(predictions) {
    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    document.getElementById('resultSection').style.display = 'block';
    document.getElementById('detailSection').style.display = 'block';
    
    // æ˜¾ç¤ºé¢„æµ‹æ—¥æœŸ
    if (predictions && predictions.length > 0) {
        if (predictions[0].prediction_date) {
            document.getElementById('predictionTargetDate').textContent = predictions[0].prediction_date;
        }
        if (predictions[0].base_date) {
            document.getElementById('predictionBaseDate').textContent = predictions[0].base_date;
        }
    }
    
    // æ¸²æŸ“è¡¨æ ¼
    const tbody = document.getElementById('predictionBody');
    tbody.innerHTML = predictions.map((pred, index) => {
        // è¿›åº¦æ¡é¢œè‰²ï¼šé¢„æµ‹æ¶¨å¹…ä¸ºæ­£æ˜¾ç¤ºçº¢è‰²ï¼Œä¸ºè´Ÿæ˜¾ç¤ºç»¿è‰²ï¼Œ0æ˜¾ç¤ºç°è‰²
        const probClass = pred.predicted_return > 0 ? 'probability-high' : 
                         pred.predicted_return < 0 ? 'probability-medium' : 'probability-low';
        
        // äº¤æ˜“ä¿¡å·é¢œè‰²
        let signalClass, signalBadge;
        switch(pred.signal) {
            case 'ä¹°å…¥':
                signalClass = 'signal-buy';
                signalBadge = 'badge-soft-success';
                break;
            case 'å¼ºçƒˆä¹°å…¥':
                signalClass = 'signal-strong-buy';
                signalBadge = 'badge-soft-success';
                break;
            case 'å–å‡º':
                signalClass = 'signal-sell';
                signalBadge = 'badge-soft-danger';
                break;
            case 'å¼ºçƒˆå–å‡º':
                signalClass = 'signal-strong-sell';
                signalBadge = 'badge-soft-danger';
                break;
            case 'è§‚æœ›':
                signalClass = 'signal-hold';
                signalBadge = 'badge-soft-warning';
                break;
            default:
                signalClass = 'signal-hold';
                signalBadge = 'badge-soft-warning';
        }
        
        // æ¶¨è·Œå¹…é¢œè‰²ï¼šæ­£ä¸ºçº¢è‰²ï¼Œè´Ÿä¸ºç»¿è‰²ï¼Œ0ä¸ºç°è‰²
        let returnClass;
        if (pred.predicted_return > 0) {
            returnClass = 'text-up';
        } else if (pred.predicted_return < 0) {
            returnClass = 'text-down';
        } else {
            returnClass = 'text-gray';
        }
        
        return `
            <tr onclick="showDetail(${index})" style="cursor: pointer;">
                <td style="color: #fff; font-weight: 700; font-size: 1rem;">${pred.sector_name}</td>
                <td>
                    <div class="d-flex align-items-center">
                        <span class="me-2" style="color: #4da3ff; font-weight: 700; width: 50px; display: inline-block; text-align: right;">${((pred.probability ?? 0) * 100).toFixed(1)}%</span>
                        <div class="probability-bar flex-grow-1">
                            <div class="probability-fill ${probClass}" style="width: ${pred.probability * 100}%"></div>
                        </div>
                    </div>
                </td>
                <td class="${returnClass}" style="font-weight: 700; font-size: 1.05rem;">
                    ${(pred.predicted_return ?? 0) >= 0 ? '+' : ''}${(pred.predicted_return ?? 0).toFixed(2)}%
                </td>
                <td>
                    <span class="badge ${signalBadge}" style="font-size: 0.9rem;">
                        <span class="signal-light ${signalClass}"></span>
                        ${pred.signal}
                    </span>
                </td>
            </tr>
        `;
    }).join('');
}

// æ ¼å¼åŒ–èµ„é‡‘æµå‘ï¼ˆä»¥ä¸‡ä¸ºå•ä½ï¼Œä¿ç•™2ä½å°æ•°ï¼‰
function formatFundFlow(value) {
    if (value === null || value === undefined || isNaN(value)) {
        return '0.00ä¸‡';
    }
    const wan = value / 10000;
    const sign = wan >= 0 ? '+' : '';
    return sign + wan.toFixed(2) + 'ä¸‡';
}

function showDetail(index) {
    const pred = currentPredictions[index];
    if (!pred || !pred.features) {
        document.getElementById('detailBody').innerHTML = `
            <p class="text-muted text-center">æš‚æ— è¯¦ç»†æ•°æ®</p>
        `;
        return;
    }
    
    const features = pred.features;
    document.getElementById('detailBody').innerHTML = `
        <h5 class="mb-3" style="color: #fff;">${pred.sector_name} - æŠ€æœ¯æŒ‡æ ‡è¯¦æƒ…</h5>
         <div class="row">
            <div class="col-md-3">
                <h6 class="text-primary" style="font-size: 1rem; margin-bottom: 0.75rem;">ä»·æ ¼ç‰¹å¾</h6>
                <table class="table table-sm table-dark">
                    <tr><td style="color: #b0b0b0;">å½“æ—¥æ¶¨è·Œ</td><td style="color: #4da3ff; font-weight: 600;">${((features.change_pct ?? 0)).toFixed(2)}%</td></tr>
                    <tr><td style="color: #b0b0b0;">5æ—¥æ¶¨è·Œ</td><td style="color: #4da3ff; font-weight: 600;">${((features.return_5d ?? 0)).toFixed(2)}%</td></tr>
                    <tr><td style="color: #b0b0b0;">10æ—¥æ¶¨è·Œ</td><td style="color: #4da3ff; font-weight: 600;">${((features.return_10d ?? 0)).toFixed(2)}%</td></tr>
                    <tr><td style="color: #b0b0b0;">20æ—¥æ¶¨è·Œ</td><td style="color: #4da3ff; font-weight: 600;">${((features.return_20d ?? 0)).toFixed(2)}%</td></tr>
                </table>
            </div>
            <div class="col-md-3">
                <h6 class="text-success" style="font-size: 1rem; margin-bottom: 0.75rem;">èµ„é‡‘ç‰¹å¾</h6>
                <table class="table table-sm table-dark">
                    <tr><td style="color: #b0b0b0;">èµ„é‡‘å‡€æµå…¥</td><td style="color: #5dd879; font-weight: 600;">${formatFundFlow(features.net_inflow)}</td></tr>
                    <tr><td style="color: #b0b0b0;">æµå…¥ç‡</td><td style="color: #5dd879; font-weight: 600;">${((features.net_inflow_rate ?? 0)).toFixed(2)}%</td></tr>
                    <tr><td style="color: #b0b0b0;">5æ—¥ç´¯è®¡</td><td style="color: #5dd879; font-weight: 600;">${formatFundFlow(features.net_inflow_5d)}</td></tr>
                    <tr><td style="color: #b0b0b0;">10æ—¥ç´¯è®¡</td><td style="color: #5dd879; font-weight: 600;">${formatFundFlow(features.net_inflow_10d)}</td></tr>
                </table>
            </div>
            <div class="col-md-3">
                <h6 class="text-warning" style="color: #ffd43b !important; font-size: 1rem; margin-bottom: 0.75rem;">åŠ¨é‡ç‰¹å¾</h6>
                <table class="table table-sm table-dark">
                    <tr><td style="color: #b0b0b0;">RSI(6)</td><td style="color: #ffd43b; font-weight: 600;">${((features.rsi_6 ?? 0)).toFixed(2)}</td></tr>
                    <tr><td style="color: #b0b0b0;">RSI(12)</td><td style="color: #ffd43b; font-weight: 600;">${((features.rsi_12 ?? 0)).toFixed(2)}</td></tr>
                    <tr><td style="color: #b0b0b0;">RSI(14)</td><td style="color: #ffd43b; font-weight: 600;">${((features.rsi_14 ?? 0)).toFixed(2)}</td></tr>
                    <tr><td style="color: #b0b0b0;">MACD</td><td style="color: #ffd43b; font-weight: 600;">${((features.macd ?? 0)).toFixed(4)}</td></tr>
                </table>
            </div>
            <div class="col-md-3">
                <h6 class="text-info" style="font-size: 1rem; margin-bottom: 0.75rem;">æˆäº¤é‡ç‰¹å¾</h6>
                <table class="table table-sm table-dark">
                    <tr><td style="color: #b0b0b0;">æˆäº¤é‡å˜åŒ–</td><td style="color: #17a2b8; font-weight: 600;">${((features.volume_change_rate ?? 0)).toFixed(2)}%</td></tr>
                    <tr><td style="color: #b0b0b0;">5æ—¥å‡é‡</td><td style="color: #17a2b8; font-weight: 600;">${((features.volume_ma5 ?? 0)).toFixed(0)}</td></tr>
                    <tr><td style="color: #b0b0b0;">20æ—¥å‡é‡</td><td style="color: #17a2b8; font-weight: 600;">${((features.volume_ma20 ?? 0)).toFixed(0)}</td></tr>
                    <tr><td style="color: #b0b0b0;">é‡ä»·é…åˆ</td><td style="color: #17a2b8; font-weight: 600;">${((features.price_volume_match ?? 0)).toFixed(2)}</td></tr>
                </table>
            </div>
        </div>
    `;
}
</script>
{% endblock %}
